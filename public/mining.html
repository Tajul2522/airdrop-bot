<!-- আগের সব CSS ঠিক থাকবে, শুধু স্ক্রিপ্ট (Script) অংশটুকু নিচেরটি দিয়ে রিপ্লেস করুন -->

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const uid = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
    let itv;

    async function load() {
        try {
            const r = await fetch(`/api?userId=${uid}`);
            const d = await r.json();
            document.getElementById('bal').innerText = d.balance || 0;
            
            // যদি আগে মাইনিং করা হয়ে থাকে (লাস্ট মাইনিং ০ এর বেশি হয়)
            if (d.lastMining && d.lastMining > 0) {
                startTimer(Number(d.lastMining));
            } else {
                document.getElementById('tm').innerText = "00:00:00";
                document.getElementById('btn').disabled = false;
            }
        } catch (e) {
            console.error("Load Error");
        }
    }

    function startTimer(lm) {
        clearInterval(itv);
        const waitTime = 12 * 60 * 60 * 1000; // 12 Hours
        const next = lm + waitTime;

        itv = setInterval(() => {
            const now = Date.now();
            const diff = next - now;

            if (diff <= 0) {
                clearInterval(itv);
                document.getElementById('tm').innerText = "00:00:00";
                document.getElementById('btn').disabled = false;
                document.getElementById('btn').innerText = "CLAIM 1000 NXRA";
            } else {
                document.getElementById('btn').disabled = true;
                document.getElementById('btn').innerText = "MINING...";
                
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                
                // NaN চেক
                if (isNaN(h) || isNaN(m) || isNaN(s)) {
                    document.getElementById('tm').innerText = "00:00:00";
                } else {
                    document.getElementById('tm').innerText = 
                        `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }
            }
        }, 1000);
    }

    async function claim() {
        document.getElementById('btn').disabled = true;
        try {
            const r = await fetch('/api', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({action: 'claim', userId: uid}) 
            });
            const d = await r.json();
            if (d.success) { 
                load(); 
                tg.HapticFeedback.notificationOccurred('success'); 
            } else {
                alert("Please wait for the timer!");
            }
        } catch (e) {
            alert("Connection Error!");
            document.getElementById('btn').disabled = false;
        }
    }
    load();
</script>
